<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sky Jump V3 - ì•„ì´í…œ ëŸ¬ì‰¬</title>
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { 
            margin: 0; padding: 0; background: #111; overflow: hidden; 
            font-family: 'Black Han Sans', sans-serif; touch-action: none;
            display: flex; justify-content: center; align-items: center; height: 100vh;
        }
        
        #gameContainer {
            position: relative; width: 100%; max-width: 500px;
            aspect-ratio: 9 / 16; max-height: 100vh;
            background: #222; box-shadow: 0 0 30px rgba(0,0,0,0.8);
            overflow: hidden; border-radius: 10px;
        }

        #gameCanvas { display: block; width: 100%; height: 100%; }

        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
        }

        .score-board {
            text-align: center; padding-top: 20px;
            color: white; text-shadow: 2px 2px 0 #000; z-index: 5;
        }
        #scoreDisplay { font-size: 3rem; color: #FFD700; }
        .best-score { font-size: 1.2rem; color: #fff; background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 20px; display: inline-block; margin-top: 5px; }

        #startScreen, #gameOverScreen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            pointer-events: auto; z-index: 20; text-align: center; color: white;
        }
        
        .btn {
            background: #00ff9d; color: black; border: none; padding: 15px 50px;
            font-size: 1.8rem; border-radius: 50px; cursor: pointer;
            font-family: 'Black Han Sans'; transition: 0.2s;
            box-shadow: 0 6px 0 #00b870; margin-top: 30px;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .btn:active { transform: translateY(5px); box-shadow: none; animation: none; }
        
        .controls-hint {
            position: absolute; bottom: 120px; width: 100%;
            display: flex; justify-content: space-between; padding: 0 30px; box-sizing: border-box;
            color: rgba(255,255,255,0.6); font-size: 2rem;
            animation: blink 2s infinite;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* í”Œë¡œíŒ… ì ìˆ˜ íš¨ê³¼ */
        .float-text {
            position: absolute; font-size: 2rem; font-weight: bold; color: #FFD700;
            text-shadow: 2px 2px 0 #000; pointer-events: none;
            animation: floatUp 0.8s forwards;
        }
        @keyframes floatUp { to { transform: translateY(-50px); opacity: 0; } }
    </style>
</head>
<body>

    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>

        <div class="ui-layer">
            <div class="score-board">
                <div id="scoreDisplay">0</div>
                <div class="best-score">ìµœê³  ê¸°ë¡: <span id="bestDisplay">0</span></div>
            </div>
            
            <div class="controls-hint" id="controlsHint">
                <span>ğŸ‘ˆ í„°ì¹˜</span>
                <span>í„°ì¹˜ ğŸ‘‰</span>
            </div>
        </div>

        <div id="startScreen">
            <img src="../../images/sky-jump/player.png" style="width:100px; margin-bottom:20px; animation: bounce 1s infinite;">
            <h1 style="font-size:3rem; margin:0; color:#00ff9d;">SKY JUMP</h1>
            <h2 style="font-size:1.5rem; color:#fff; font-weight:normal;">ì•„ì´í…œì„ ë¨¹ê³  ë‚ ì•„ì˜¤ë¥´ì„¸ìš”!</h2>
            <div style="margin-top:20px; display:flex; gap:15px; justify-content:center;">
                <div style="text-align:center;"><img src="../../images/sky-jump/star.png" width="30"><br><span style="font-size:0.8rem;">+50ì </span></div>
                <div style="text-align:center;"><img src="../../images/sky-jump/rocket.png" width="30"><br><span style="font-size:0.8rem;">ë¶€ìŠ¤í„°</span></div>
            </div>
            <button class="btn" onclick="startGame()">ê²Œì„ ì‹œì‘</button>
        </div>

        <div id="gameOverScreen" style="display:none;">
            <h1 style="color:#ff4757; font-size:3.5rem; margin:0;">GAME OVER</h1>
            <p style="font-size:1.5rem; margin-top:10px;">ìµœì¢… ì ìˆ˜: <span id="finalScore" style="color:#FFD700">0</span></p>
            <button class="btn" onclick="resetGame()">ë‹¤ì‹œ ë„ì „</button>
            <a href="../../index.html" style="color:#aaa; margin-top:30px; text-decoration:none; border-bottom:1px solid #aaa;">í™ˆìœ¼ë¡œ ë‚˜ê°€ê¸°</a>
        </div>
    </div>

    <audio id="bgm" src="../../audio/bgm_fast.mp3" loop></audio>
    <audio id="sfx-jump" src="../../audio/jump.mp3"></audio>
    <audio id="sfx-item" src="../../audio/coin.mp3"></audio> <audio id="sfx-rocket" src="../../audio/open.mp3"></audio> <audio id="sfx-over" src="../../audio/gameover.mp3"></audio>

    <script src="../../js/ads.js"></script>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const GAME_WIDTH = 500;
        const GAME_HEIGHT = 900;
        canvas.width = GAME_WIDTH;
        canvas.height = GAME_HEIGHT;
        
        // ì´ë¯¸ì§€ ë¡œë“œ
        const imgPlayer = new Image(); imgPlayer.src = "../../images/sky-jump/player.png";
        const imgPlatform = new Image(); imgPlatform.src = "../../images/sky-jump/platform.png";
        const imgStar = new Image(); imgStar.src = "../../images/sky-jump/star.png";
        const imgRocket = new Image(); imgRocket.src = "../../images/sky-jump/rocket.png";
        
        const bgImages = [];
        ["bg_stage1.png", "bg_stage2.png", "bg_stage3.png"].forEach(src => {
            const img = new Image(); img.src = `../../images/sky-jump/${src}`; bgImages.push(img);
        });
        
        // ê²Œì„ ë³€ìˆ˜
        let gameLoop;
        let score = 0;
        let bestScore = localStorage.getItem('skyJumpBestV3') || 0;
        let platforms = [];
        let items = []; // ì•„ì´í…œ ë°°ì—´
        let isGameOver = false;
        
        // [ì¤‘ìš”] ìºë¦­í„° ì„¤ì • - í†µí†µí•˜ê²Œ ë§Œë“¤ê¸°
        const player = {
            x: GAME_WIDTH / 2 - 40, 
            y: GAME_HEIGHT - 150, 
            width: 80,   // ë„ˆë¹„ëŠ” ë„“ê²Œ
            height: 60,  // ë†’ì´ëŠ” ë‚®ê²Œ -> í†µí†µí•œ ë¹„ìœ¨!
            dx: 0, dy: 0, speed: 8, jumpPower: -16, gravity: 0.6
        };

        const keys = { left: false, right: false };
        document.getElementById('bestDisplay').innerText = bestScore;

        function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            const bgm = document.getElementById('bgm'); bgm.volume = 0.3; bgm.play().catch(()=>{});
            resetGame();
        }

        function resetGame() {
            document.getElementById('gameOverScreen').style.display = 'none';
            score = 0;
            document.getElementById('scoreDisplay').innerText = score;
            player.dy = 0;
            player.y = GAME_HEIGHT - 150;
            player.x = GAME_WIDTH / 2 - player.width / 2;
            platforms = [];
            items = [];
            isGameOver = false;
            
            // ì‹œì‘ ë°œíŒ
            platforms.push({ x: GAME_WIDTH/2 - 60, y: GAME_HEIGHT - 80, w: 120, h: 25 });
            generateContent(GAME_HEIGHT - 150);
            
            if(gameLoop) cancelAnimationFrame(gameLoop);
            gameLoop = requestAnimationFrame(update);
        }

        // ë°œíŒ & ì•„ì´í…œ ìƒì„±ê¸°
        function generateContent(startY) {
            for (let i = 0; i < 15; i++) {
                let y = startY - 90 - i * 100; // ê°„ê²© ë„“í˜
                let w = 90 + Math.random() * 40;
                let x = Math.random() * (GAME_WIDTH - w);
                
                platforms.push({ x: x, y: y, w: w, h: 25 });

                // 30% í™•ë¥ ë¡œ ì•„ì´í…œ ìƒì„±
                if (Math.random() < 0.3) {
                    let type = Math.random() < 0.8 ? 'star' : 'rocket'; // ë³„ 80%, ë¡œì¼“ 20%
                    items.push({ x: x + w/2 - 15, y: y - 40, w: 30, h: 30, type: type });
                }
            }
        }

        function update() {
            if (isGameOver) return;
            ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
            
            // ë°°ê²½ ê·¸ë¦¬ê¸°
            let bgIndex = Math.floor(score / 500); // 500ì ë§ˆë‹¤ ë°°ê²½ ë³€ê²½ (ì ìˆ˜ ì¸í”Œë ˆ ê³ ë ¤)
            if (bgIndex >= bgImages.length) bgIndex = bgImages.length - 1;
            const currentBg = bgImages[bgIndex];
            
            if(currentBg && currentBg.complete) {
                const scale = Math.max(GAME_WIDTH / currentBg.width, GAME_HEIGHT / currentBg.height);
                const x = (GAME_WIDTH - currentBg.width * scale) / 2;
                const y = (GAME_HEIGHT - currentBg.height * scale) / 2;
                ctx.drawImage(currentBg, x, y, currentBg.width * scale, currentBg.height * scale);
            } else {
                ctx.fillStyle = "#87CEEB"; ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
            }

            // í”Œë ˆì´ì–´ ì¢Œìš° ì´ë™
            if (keys.left) player.x -= player.speed;
            if (keys.right) player.x += player.speed;

            // í™”ë©´ ë°– ì´ë™ ì²˜ë¦¬ (í†µê³¼)
            if (player.x + player.width < 0) player.x = GAME_WIDTH;
            else if (player.x > GAME_WIDTH) player.x = -player.width;

            // ì¤‘ë ¥
            player.dy += player.gravity;
            player.y += player.dy;

            // [ë¡œì§] ë°œíŒ ì¶©ëŒ
            platforms.forEach(p => {
                if (
                    player.dy > 0 && // ë–¨ì–´ì§ˆ ë•Œë§Œ
                    player.y + player.height > p.y &&
                    player.y + player.height < p.y + p.h + 20 &&
                    player.x + player.width > p.x + 10 &&
                    player.x < p.x + p.w - 10
                ) {
                    player.dy = player.jumpPower;
                    playSound('jump');
                }
                if(imgPlatform.complete) ctx.drawImage(imgPlatform, p.x, p.y, p.w, p.h);
                else { ctx.fillStyle = "#fff"; ctx.fillRect(p.x, p.y, p.w, p.h); }
            });

            // [ë¡œì§] ì•„ì´í…œ ì¶©ëŒ
            for (let i = items.length - 1; i >= 0; i--) {
                let it = items[i];
                // ì•„ì´í…œ ê·¸ë¦¬ê¸°
                let img = it.type === 'star' ? imgStar : imgRocket;
                if(img.complete) ctx.drawImage(img, it.x, it.y, it.w, it.h);

                // ì¶©ëŒ ì²´í¬
                if (
                    player.x < it.x + it.w &&
                    player.x + player.width > it.x &&
                    player.y < it.y + it.h &&
                    player.y + player.height > it.y
                ) {
                    // ì•„ì´í…œ íšë“!
                    items.splice(i, 1);
                    if (it.type === 'star') {
                        score += 50;
                        showFloatText("+50", it.x, it.y);
                        playSound('item');
                    } else if (it.type === 'rocket') {
                        player.dy = -35; // ìŠˆí¼ ì í”„!
                        showFloatText("BOOST!!", it.x, it.y);
                        playSound('rocket');
                    }
                    document.getElementById('scoreDisplay').innerText = score;
                }
            }

            // [ë¡œì§] í™”ë©´ ìŠ¤í¬ë¡¤
            if (player.y < GAME_HEIGHT / 2.5) {
                let diff = GAME_HEIGHT / 2.5 - player.y;
                player.y = GAME_HEIGHT / 2.5;
                
                // ë°œíŒ ì´ë™
                platforms.forEach((p, index) => {
                    p.y += diff;
                    if (p.y > GAME_HEIGHT) {
                        platforms.splice(index, 1);
                        score += 10; // ì˜¬ë¼ê°€ê¸°ë§Œ í•´ë„ ì ìˆ˜
                        document.getElementById('scoreDisplay').innerText = score;
                        
                        // ìƒˆ ë°œíŒ ì¶”ê°€
                        let highestY = platforms[platforms.length-1].y;
                        let y = highestY - 100;
                        let w = 90 + Math.random() * 40;
                        let x = Math.random() * (GAME_WIDTH - w);
                        platforms.push({ x: x, y: y, w: w, h: 25 });
                        
                        // ìƒˆ ì•„ì´í…œ ì¶”ê°€
                        if (Math.random() < 0.3) {
                             let type = Math.random() < 0.8 ? 'star' : 'rocket';
                             items.push({ x: x + w/2 - 15, y: y - 40, w: 30, h: 30, type: type });
                        }
                    }
                });
                
                // ì•„ì´í…œ ì´ë™
                items.forEach((it, index) => {
                    it.y += diff;
                    if(it.y > GAME_HEIGHT) items.splice(index, 1);
                });
            }

            // í”Œë ˆì´ì–´ ê·¸ë¦¬ê¸° (í†µí†µí•œ ë¹„ìœ¨ ì ìš©ë¨)
            if(imgPlayer.complete) ctx.drawImage(imgPlayer, player.x, player.y, player.width, player.height);
            else { ctx.fillStyle = "lime"; ctx.fillRect(player.x, player.y, player.width, player.height); }

            // ê²Œì„ ì˜¤ë²„
            if (player.y > GAME_HEIGHT) gameOver();
            else gameLoop = requestAnimationFrame(update);
        }

        function showFloatText(text, x, y) {
            const el = document.createElement('div');
            el.className = 'float-text';
            el.innerText = text;
            el.style.left = (x + document.getElementById('gameContainer').getBoundingClientRect().left) + 'px'; // ì¢Œí‘œ ë³´ì •
            el.style.top = y + 'px';
            document.getElementById('gameContainer').appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        function gameOver() {
            isGameOver = true;
            cancelAnimationFrame(gameLoop);
            playSound('over');
            document.getElementById('bgm').pause();
            
            if(score > bestScore) {
                bestScore = score;
                localStorage.setItem('skyJumpBestV3', bestScore);
                document.getElementById('bestDisplay').innerText = bestScore;
            }
            document.getElementById('finalScore').innerText = score;
            document.getElementById('gameOverScreen').style.display = 'flex';
        }

        function playSound(id) {
            const s = document.getElementById(id === 'item' ? 'sfx-item' : id === 'rocket' ? 'sfx-rocket' : id === 'jump' ? 'sfx-jump' : 'sfx-over');
            if(s) { s.currentTime = 0; s.play().catch(()=>{}); }
        }

        // ì¡°ì‘ (PC + ëª¨ë°”ì¼)
        const handleDown = (left) => { if(left) keys.left = true; else keys.right = true; document.getElementById('controlsHint').style.display='none'; };
        const handleUp = () => { keys.left = false; keys.right = false; };

        window.addEventListener('keydown', e => { if(e.code==='ArrowLeft') handleDown(true); if(e.code==='ArrowRight') handleDown(false); });
        window.addEventListener('keyup', handleUp);
        window.addEventListener('touchstart', e => { e.preventDefault(); handleDown(e.touches[0].clientX < window.innerWidth/2); }, {passive:false});
        window.addEventListener('touchend', e => { e.preventDefault(); handleUp(); }, {passive:false});

    </script>
</body>
</html>
