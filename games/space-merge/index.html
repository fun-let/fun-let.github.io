<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Space Merge - 행성 합치기</title>
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    
    <style>
        body { 
            margin: 0; padding: 0; background: #0f0f1a; overflow: hidden; 
            font-family: 'Black Han Sans', sans-serif; touch-action: none;
            display: flex; justify-content: center; align-items: center; 
            height: 100vh; height: 100dvh; /* 모바일 대응 */
        }
        
        /* 전체 컨테이너 (Flexbox 적용으로 겹침 방지) */
        #gameContainer {
            width: 100%; max-width: 450px; height: 100%;
            background: #161626; 
            display: flex; flex-direction: column; /* 세로 정렬 */
            border-left: 2px solid #333; border-right: 2px solid #333;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        /* 1. 상단 UI (고정 높이) */
        .ui-header {
            height: 80px; padding: 15px; flex-shrink: 0;
            display: flex; justify-content: space-between; align-items: flex-start;
            background: rgba(0,0,0,0.2); z-index: 10;
        }

        .score-box { color: white; text-shadow: 2px 2px 0 #000; }
        .score-label { font-size: 0.8rem; color: #aaa; }
        .score-val { font-size: 2rem; color: #00ff9d; display: block; line-height: 1;}

        .next-box { text-align: right; }
        .next-preview {
            width: 50px; height: 50px; background: rgba(255,255,255,0.1);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            border: 2px solid #444; margin-top: 5px;
        }
        .next-preview img { max-width: 80%; max-height: 80%; }

        /* 2. 게임 월드 (남은 공간 모두 차지) */
        #world {
            flex: 1; /* 남은 공간 꽉 채우기 */
            position: relative;
            overflow: hidden;
            border-bottom: 1px solid #333;
            cursor: pointer;
        }
        
        /* 캔버스는 world 안에 꽉 차게 */
        canvas { display: block; width: 100%; height: 100%; }

        /* 3. 하단 광고 (고정 높이, 절대 겹치지 않음) */
        .ad-area {
            height: 100px; flex-shrink: 0;
            background: #000; display: flex; justify-content: center; align-items: center;
            border-top: 1px solid #333;
        }

        /* 게임 오버 화면 */
        #gameOverScreen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 50; display: none;
            flex-direction: column; align-items: center; justify-content: center;
            color: white; text-align: center;
        }
        .btn {
            background: #00ff9d; color: black; border: none; padding: 15px 40px;
            font-size: 1.5rem; border-radius: 50px; cursor: pointer;
            font-family: 'Black Han Sans'; margin-top: 20px;
            box-shadow: 0 5px 0 #00b870; transition: 0.2s; pointer-events: auto;
        }
        
        /* 데드라인 (월드 내부에 위치) */
        .dead-line {
            position: absolute; top: 100px; left: 0; width: 100%; height: 2px;
            background: repeating-linear-gradient(90deg, transparent, transparent 10px, #ff4757 10px, #ff4757 20px);
            opacity: 0.5; z-index: 5; pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="gameContainer">
        <div class="ui-header">
            <div class="score-box">
                <span class="score-label">SCORE</span>
                <span class="score-val" id="scoreDisplay">0</span>
            </div>
            <div class="next-box">
                <span class="score-label">NEXT</span>
                <div class="next-preview">
                    <img id="nextImg" src="">
                </div>
            </div>
        </div>

        <div id="world">
            <div class="dead-line"></div>
            <div id="gameOverScreen">
                <h1 style="color:#ff4757; font-size:3.5rem; margin:0;">GAME OVER</h1>
                <p style="font-size:1.5rem; margin-top:10px;">최종 점수: <span id="finalScore">0</span></p>
                <button class="btn" onclick="location.reload()">다시 도전</button>
                <a href="../../index.html" style="color:#aaa; margin-top:30px; display:block; text-decoration:none;">홈으로 나가기</a>
            </div>
        </div>

        <div class="ad-area" id="ad-game-bottom"></div>
    </div>

    <audio id="bgm" src="../../audio/space-merge/bgm_space.mp3" loop></audio>
    <audio id="sfx-drop" src="../../audio/space-merge/sfx_drop.mp3"></audio>
    <audio id="sfx-merge" src="../../audio/space-merge/sfx_merge.mp3"></audio>

    <script src="../../js/ads.js"></script>

    <script>
        // Matter.js 모듈
        const Engine = Matter.Engine,
              Render = Matter.Render,
              Runner = Matter.Runner,
              Bodies = Matter.Bodies,
              Composite = Matter.Composite,
              Events = Matter.Events,
              World = Matter.World,
              Body = Matter.Body;

        // 게임 설정 (이미지 경로)
        const PLANETS = [
            { r: 20, s: 10, img: 'planet_0.png' }, { r: 30, s: 20, img: 'planet_1.png' },
            { r: 40, s: 40, img: 'planet_2.png' }, { r: 50, s: 80, img: 'planet_3.png' },
            { r: 65, s: 160, img: 'planet_4.png' }, { r: 80, s: 320, img: 'planet_5.png' },
            { r: 95, s: 640, img: 'planet_6.png' }, { r: 110, s: 1280, img: 'planet_7.png' },
            { r: 125, s: 2560, img: 'planet_8.png' }, { r: 140, s: 5120, img: 'planet_9.png' },
            { r: 155, s: 10000, img: 'planet_10.png'}
        ];

        // 캔버스 크기 계산 (flex 영역에 맞춤)
        const worldElem = document.getElementById('world');
        const width = worldElem.clientWidth;
        const height = worldElem.clientHeight;
        
        let score = 0;
        let nextIdx = 0;
        let currentBody = null;
        let canDrop = true;
        let isGameOver = false;

        const engine = Engine.create();
        const world = engine.world;

        // 렌더러 생성
        const render = Render.create({
            element: worldElem,
            engine: engine,
            options: {
                width: width,
                height: height,
                wireframes: false,
                background: 'transparent'
            }
        });

        // 벽 생성
        const wallOpt = { isStatic: true, render: { fillStyle: '#222' } };
        const ground = Bodies.rectangle(width/2, height + 30, width, 60, wallOpt); // 바닥
        const leftWall = Bodies.rectangle(-30, height/2, 60, height * 2, wallOpt); // 좌
        const rightWall = Bodies.rectangle(width + 30, height/2, 60, height * 2, wallOpt); // 우
        
        World.add(world, [ground, leftWall, rightWall]);

        Render.run(render);
        const runner = Runner.create();
        Runner.run(runner, engine);

        // --- 핵심: 행성 생성 및 머지 로직 ---

        function createPlanet(x, y, idx, isStatic) {
            const p = PLANETS[idx];
            // 중요: customLevel 속성을 바디에 직접 부여
            const body = Bodies.circle(x, y, p.r, {
                label: 'planet',
                isStatic: isStatic,
                restitution: 0.3, // 탄성
                friction: 0.1,
                render: {
                    sprite: {
                        texture: `../../images/space-merge/${p.img}`,
                        xScale: (p.r * 2) / 100, // 이미지 100px 기준 비율 조정
                        yScale: (p.r * 2) / 100
                    },
                    fillStyle: '#fff' // 이미지가 없을 때
                }
            });
            body.gameLevel = idx; // 머지 체크용 레벨
            body.isUsed = false;  // 중복 머지 방지용 플래그
            return body;
        }

        function setNext() {
            nextIdx = Math.floor(Math.random() * 4); // 0~3단계 중 랜덤
            document.getElementById('nextImg').src = `../../images/space-merge/${PLANETS[nextIdx].img}`;
        }

        function spawnReady() {
            if(isGameOver) return;
            // 상단 대기 행성 생성
            currentBody = createPlanet(width/2, 50, nextIdx, true);
            currentBody.isSleeping = true; // 물리 영향 안 받게
            World.add(world, currentBody);
            canDrop = true;
            setNext();
        }

        // 입력 처리 (위치 이동)
        const handleInput = (x) => {
            if(isGameOver || !canDrop || !currentBody) return;
            const r = PLANETS[nextIdx].r;
            // 벽 밖으로 나가지 않게 제한
            if(x < r) x = r;
            if(x > width - r) x = width - r;
            Body.setPosition(currentBody, { x: x, y: 50 });
        };

        // 드롭 처리
        const handleDrop = () => {
            if(isGameOver || !canDrop || !currentBody) return;
            canDrop = false;
            
            // 물리 활성화
            Body.setStatic(currentBody, false);
            currentBody.isSleeping = false;
            
            try { document.getElementById('sfx-drop').play(); } catch(e){}
            
            // BGM 재생 시도 (사용자 인터랙션 이후)
            const bgm = document.getElementById('bgm');
            if(bgm.paused) { bgm.volume=0.3; bgm.play().catch(()=>{}); }

            currentBody = null;
            setTimeout(spawnReady, 600); // 0.6초 뒤 다음 행성 준비
        };

        // 이벤트 리스너 (마우스/터치)
        const el = document.getElementById('gameContainer'); // 전체 컨테이너 기준
        
        el.addEventListener('mousemove', e => handleInput(e.clientX - el.getBoundingClientRect().left));
        el.addEventListener('touchmove', e => { 
            e.preventDefault(); 
            handleInput(e.touches[0].clientX - el.getBoundingClientRect().left); 
        }, {passive: false});
        
        el.addEventListener('mouseup', handleDrop);
        el.addEventListener('touchend', handleDrop);

        // [수정된 머지 로직]
        Events.on(engine, 'collisionStart', (event) => {
            const pairs = event.pairs;
            
            for (let i = 0; i < pairs.length; i++) {
                const bodyA = pairs[i].bodyA;
                const bodyB = pairs[i].bodyB;

                // 둘 다 행성이고, 레벨이 같고, 아직 합체 안 된 상태라면
                if (bodyA.gameLevel !== undefined && bodyB.gameLevel !== undefined && 
                    bodyA.gameLevel === bodyB.gameLevel && 
                    !bodyA.isUsed && !bodyB.isUsed) {
                    
                    const level = bodyA.gameLevel;
                    
                    // 마지막 단계(태양)가 아니면 합체
                    if (level < PLANETS.length - 1) {
                        bodyA.isUsed = true; // 중복 방지
                        bodyB.isUsed = true;

                        // 중간 위치 계산
                        const midX = (bodyA.position.x + bodyB.position.x) / 2;
                        const midY = (bodyA.position.y + bodyB.position.y) / 2;

                        // 기존 행성 제거
                        World.remove(world, [bodyA, bodyB]);

                        // 새 행성 생성 (다음 레벨)
                        const newBody = createPlanet(midX, midY, level + 1, false);
                        World.add(world, newBody);

                        // 점수 & 효과음
                        score += PLANETS[level].s;
                        document.getElementById('scoreDisplay').innerText = score;
                        try { 
                            const sfx = document.getElementById('sfx-merge');
                            sfx.currentTime=0; sfx.play();
                        } catch(e){}
                    }
                }
            }
        });

        // 게임 오버 체크 (데드라인)
        setInterval(() => {
            if(isGameOver) return;
            const bodies = Composite.allBodies(world);
            for(let body of bodies) {
                // 정지해있지 않고(움직임은 거의 멈춤), 데드라인(100px)보다 위에 있고, 현재 조작중인 행성이 아닐 때
                if(!body.isStatic && body.position.y < 100 && body !== currentBody) {
                    // 속도가 느릴 때만 게임오버 (떨어지는 중인 건 제외)
                    if(Math.abs(body.velocity.y) < 0.2) {
                        gameOver();
                        break;
                    }
                }
            }
        }, 1000);

        function gameOver() {
            isGameOver = true;
            document.getElementById('finalScore').innerText = score;
            document.getElementById('gameOverScreen').style.display = 'flex';
            document.getElementById('bgm').pause();
        }

        // 초기화 실행
        setNext();
        spawnReady();

        // 윈도우 리사이즈 대응 (새로고침 권장)
        window.addEventListener('resize', () => {
            // 캔버스 크기 재조정은 복잡하므로 레이아웃만 CSS가 처리하도록 함
        });

    </script>
</body>
</html>