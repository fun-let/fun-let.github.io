<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FUNLET ë§ˆìŠ¤í„° ê´€ë¦¬ì V4</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: #111; color: white; font-family: 'Noto Sans KR'; padding: 20px; margin: 0; }
        .container { max-width: 800px; margin: 0 auto; background: #222; padding: 30px; border-radius: 20px; border: 1px solid #333; }
        h2 { text-align: center; color: #00ff9d; margin-bottom: 30px; }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #ccc; }
        input, select { width: 100%; padding: 12px; background: #333; border: 1px solid #555; color: white; border-radius: 8px; box-sizing: border-box; }
        
        /* íƒ­ ë””ìì¸ */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .tab-btn { flex: 1; padding: 10px; background: transparent; border: none; color: #888; cursor: pointer; font-size: 1.1rem; font-weight: bold; }
        .tab-btn.active { color: #00ff9d; border-bottom: 3px solid #00ff9d; }
        
        /* íŒŒì¼ ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ë“œ */
        .file-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
        .file-card { background: #2a2a2a; border: 1px solid #444; border-radius: 10px; padding: 10px; text-align: center; cursor: pointer; transition: 0.2s; }
        .file-card:hover { border-color: #00ff9d; transform: translateY(-3px); }
        .file-card img { width: 100%; height: 100px; object-fit: contain; background: #000; border-radius: 5px; margin-bottom: 10px; }
        .file-name { font-size: 0.8rem; color: #ddd; word-break: break-all; }
        
        /* ë§í¬ ì—ë””í„° ìŠ¤íƒ€ì¼ */
        .link-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; background: #2a2a2a; padding: 10px; border-radius: 8px; }
        .link-key { width: 30%; font-weight: bold; color: #00ff9d; }
        
        button { padding: 10px 20px; background: #00ff9d; color: black; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        button:hover { background: #00cc7d; }
        .btn-upload { width: 100%; margin-top: 10px; font-size: 1.1rem; padding: 15px; }

        .hidden { display: none; }
        .loading { text-align: center; color: #888; padding: 20px; }
    </style>
</head>
<body>

    <div class="container">
        <h2>ğŸ”§ FUNLET ì™„ì „ ìë™ ê´€ë¦¬ì</h2>

        <div class="form-group">
            <label>ğŸ”‘ ê´€ë¦¬ì í† í° (ìë™ ì €ì¥ë¨)</label>
            <input type="password" id="token" placeholder="ghp_..." onchange="saveToken()">
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('files')">ğŸ“‚ ì´ë¯¸ì§€ ê´€ë¦¬ (ìë™ ìŠ¤ìº”)</button>
            <button class="tab-btn" onclick="switchTab('links')">ğŸ”— ë°°ë„ˆ ë§í¬ ê´€ë¦¬</button>
        </div>

        <div id="tab-files">
            <div class="form-group">
                <label>1. í´ë” ì„ íƒ (GitHubì—ì„œ ì‹¤ì‹œê°„ ì¡°íšŒ)</label>
                <select id="folderSelect" onchange="loadFiles(this.value)">
                    <option value="">í† í°ì„ ì…ë ¥í•˜ê³  ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</option>
                </select>
                <button onclick="scanFolders()" style="margin-top:5px; background:#444; color:white; width:auto; padding:5px 10px; font-size:0.8rem;">ğŸ”„ í´ë” ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
            </div>

            <div id="fileListArea">
                <label>2. êµì²´í•  ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”</label>
                <div id="fileGrid" class="file-grid">
                    <div class="loading">í´ë”ë¥¼ ì„ íƒí•˜ë©´ íŒŒì¼ì´ ëœ¹ë‹ˆë‹¤.</div>
                </div>
            </div>

            <div id="uploadForm" class="hidden" style="margin-top:20px; border-top:1px solid #444; padding-top:20px;">
                <h3 style="color:white;">ğŸ”„ ì´ë¯¸ì§€ êµì²´í•˜ê¸°</h3>
                <p>ì„ íƒëœ íŒŒì¼: <b id="selectedFileName" style="color:#00ff9d;"></b></p>
                <input type="file" id="fileInput" accept="image/*">
                <button class="btn-upload" onclick="uploadImage()">ì„œë²„ì— ë®ì–´ì“°ê¸°</button>
            </div>
        </div>

        <div id="tab-links" class="hidden">
            <p style="color:#aaa; font-size:0.9rem;">* ads.json íŒŒì¼ì— ìˆëŠ” ëª¨ë“  ë°°ë„ˆ ë§í¬ë¥¼ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</p>
            <div id="linkList">
                <div class="loading">ë°ì´í„° ë¡œë”© ì¤‘...</div>
            </div>
            <button class="btn-upload" onclick="saveLinks()">ëª¨ë“  ë§í¬ ì €ì¥í•˜ê¸°</button>
        </div>

    </div>

    <script>
        const USER = 'fun-let';
        const REPO = 'funlet';
        let currentPath = '';
        let currentAdsData = {};
        let adsSha = null;

        window.onload = () => {
            const t = localStorage.getItem('github_token');
            if(t) {
                document.getElementById('token').value = t;
                scanFolders(); // ì‹œì‘í•˜ìë§ˆì í´ë” ìŠ¤ìº”
            }
        }

        function saveToken() {
            localStorage.setItem('github_token', document.getElementById('token').value);
            scanFolders();
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            if(tab === 'files') {
                document.getElementById('tab-files').classList.remove('hidden');
                document.getElementById('tab-links').classList.add('hidden');
            } else {
                document.getElementById('tab-files').classList.add('hidden');
                document.getElementById('tab-links').classList.remove('hidden');
                loadLinks(); // íƒ­ ì „í™˜ ì‹œ ë§í¬ ë°ì´í„° ë¡œë“œ
            }
        }

        // ==========================================
        // 1. í´ë” ë° íŒŒì¼ ìë™ ìŠ¤ìº” ê¸°ëŠ¥
        // ==========================================
        async function scanFolders() {
            const token = document.getElementById('token').value;
            if(!token) return;
            const select = document.getElementById('folderSelect');
            select.innerHTML = '<option>ìŠ¤ìº” ì¤‘...</option>';

            try {
                // images í´ë” ì•ˆì˜ ëª¨ë“  ê²ƒì„ ì¡°íšŒ
                const url = `https://api.github.com/repos/${USER}/${REPO}/contents/images`;
                const res = await fetch(url, { headers: { Authorization: `token ${token}` } });
                const data = await res.json();

                select.innerHTML = '<option value="">-- í´ë”ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>';
                // ë£¨íŠ¸(images/) ì¶”ê°€
                select.innerHTML += `<option value="images/">images/ (ê¸°ë³¸ ë°°ë„ˆ)</option>`;

                // í•˜ìœ„ í´ë” ìë™ ì¶”ê°€
                data.forEach(item => {
                    if(item.type === 'dir') {
                        select.innerHTML += `<option value="${item.path}/">${item.path}/</option>`;
                    }
                });
            } catch(e) {
                alert("í´ë” ìŠ¤ìº” ì‹¤íŒ¨. í† í°ì„ í™•ì¸í•˜ì„¸ìš”.");
            }
        }

        async function loadFiles(path) {
            if(!path) return;
            currentPath = path;
            const token = document.getElementById('token').value;
            const grid = document.getElementById('fileGrid');
            grid.innerHTML = '<div class="loading">íŒŒì¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            document.getElementById('uploadForm').classList.add('hidden');

            try {
                const url = `https://api.github.com/repos/${USER}/${REPO}/contents/${path}`;
                const res = await fetch(url, { headers: { Authorization: `token ${token}` } });
                const data = await res.json();

                grid.innerHTML = '';
                data.forEach(item => {
                    if(item.type === 'file' && item.name.match(/\.(jpg|jpeg|png|gif)$/i)) {
                        // ì¹´ë“œ ìƒì„±
                        const card = document.createElement('div');
                        card.className = 'file-card';
                        card.onclick = () => selectFile(item.name);
                        card.innerHTML = `
                            <img src="${item.download_url}?t=${new Date().getTime()}">
                            <div class="file-name">${item.name}</div>
                        `;
                        grid.appendChild(card);
                    }
                });
                
                if(grid.innerHTML === '') grid.innerHTML = '<div class="loading">ì´ë¯¸ì§€ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';

            } catch(e) {
                grid.innerHTML = '<div class="loading">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>';
            }
        }

        function selectFile(name) {
            document.getElementById('uploadForm').classList.remove('hidden');
            document.getElementById('selectedFileName').innerText = name;
            // ìŠ¤í¬ë¡¤ ì´ë™
            document.getElementById('uploadForm').scrollIntoView({behavior: "smooth"});
        }

        // ==========================================
        // 2. ì´ë¯¸ì§€ ì—…ë¡œë“œ (ë®ì–´ì“°ê¸°)
        // ==========================================
        async function uploadImage() {
            const token = document.getElementById('token').value;
            const fileName = document.getElementById('selectedFileName').innerText;
            const fileInput = document.getElementById('fileInput');
            
            if(fileInput.files.length === 0) { alert("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }

            const file = fileInput.files[0];
            const fullPath = currentPath + fileName; // ê²½ë¡œ + íŒŒì¼ëª…

            if(!confirm(`[${fileName}] íŒŒì¼ì„ ì •ë§ êµì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async function() {
                const content = reader.result.split(',')[1];
                
                // ê¸°ì¡´ íŒŒì¼ SHA ì¡°íšŒ (ë®ì–´ì“°ê¸° í•„ìˆ˜)
                let sha = null;
                try {
                    const check = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/${fullPath}`, {
                        headers: { Authorization: `token ${token}` }
                    });
                    const d = await check.json();
                    sha = d.sha;
                } catch(e) {}

                // ì—…ë¡œë“œ
                try {
                    const res = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/${fullPath}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `Update ${fileName}`,
                            content: content,
                            sha: sha
                        })
                    });

                    if(res.ok) {
                        alert("ì„±ê³µ! ì´ë¯¸ì§€ê°€ êµì²´ë˜ì—ˆìŠµë‹ˆë‹¤.\nì‚¬ì´íŠ¸ ë°˜ì˜ê¹Œì§€ 1~2ë¶„ ê±¸ë¦½ë‹ˆë‹¤.");
                        loadFiles(currentPath); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    } else {
                        alert("ì—…ë¡œë“œ ì‹¤íŒ¨.");
                    }
                } catch(e) {
                    alert("ì˜¤ë¥˜ ë°œìƒ: " + e);
                }
            };
        }

        // ==========================================
        // 3. ë°°ë„ˆ ë§í¬ ê´€ë¦¬ (JSON ìë™ íŒŒì‹±)
        // ==========================================
        async function loadLinks() {
            const token = document.getElementById('token').value;
            const list = document.getElementById('linkList');
            list.innerHTML = '<div class="loading">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

            try {
                const url = `https://api.github.com/repos/${USER}/${REPO}/contents/data/ads.json`;
                const res = await fetch(url, { headers: { Authorization: `token ${token}` } });
                const data = await res.json();
                
                adsSha = data.sha;
                const decoded = new TextDecoder().decode(Uint8Array.from(atob(data.content), c => c.charCodeAt(0)));
                currentAdsData = JSON.parse(decoded);

                list.innerHTML = '';
                // JSONì˜ ëª¨ë“  í‚¤ë¥¼ ìë™ìœ¼ë¡œ ë£¨í”„ ëŒë©´ì„œ ì…ë ¥ì°½ ìƒì„±
                for (const [key, value] of Object.entries(currentAdsData)) {
                    // í‚¤ ì´ë¦„ ì¢€ ë” ì˜ˆì˜ê²Œ ë³´ì—¬ì£¼ê¸°
                    let labelName = key;
                    if(key === 'hero') labelName = 'âœ¨ ë©”ì¸ íƒ€ì´í‹€ (Hero)';
                    if(key === 'mainTop') labelName = 'ğŸ–¥ï¸ ë©”ì¸ ìƒë‹¨ ë°°ë„ˆ';
                    if(key === 'gameBottom') labelName = 'ğŸ“± ê²Œì„ í•˜ë‹¨ ë°°ë„ˆ';
                    if(key === 'sidebar') labelName = 'â– ì‚¬ì´ë“œë°” ë°°ë„ˆ';

                    const row = document.createElement('div');
                    row.className = 'link-row';
                    row.innerHTML = `
                        <div class="link-key">${labelName}</div>
                        <input type="text" id="link-${key}" value="${value.link || '#'}" placeholder="ì´ë™í•  ì£¼ì†Œ ì…ë ¥ (https://...)">
                    `;
                    list.appendChild(row);
                }

            } catch(e) {
                list.innerHTML = '<div class="loading">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨. ads.json íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.</div>';
            }
        }

        async function saveLinks() {
            const token = document.getElementById('token').value;
            
            // ì…ë ¥ëœ ê°’ìœ¼ë¡œ ë°ì´í„° ì—…ë°ì´íŠ¸
            for (const key of Object.keys(currentAdsData)) {
                const input = document.getElementById(`link-${key}`);
                if(input) {
                    currentAdsData[key].link = input.value;
                }
            }

            // JSON ì €ì¥
            try {
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(currentAdsData, null, 2))));
                const url = `https://api.github.com/repos/${USER}/${REPO}/contents/data/ads.json`;
                
                const res = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: "Update Links via Admin V4",
                        content: content,
                        sha: adsSha
                    })
                });

                if(res.ok) {
                    const d = await res.json();
                    adsSha = d.content.sha; // SHA ê°±ì‹ 
                    alert("ë§í¬ ì €ì¥ ì™„ë£Œ! ë°”ë¡œ ì ìš©ë©ë‹ˆë‹¤.");
                } else {
                    alert("ì €ì¥ ì‹¤íŒ¨");
                }
            } catch(e) {
                alert("ì˜¤ë¥˜: " + e);
            }
        }
    </script>
</body>
</html>
