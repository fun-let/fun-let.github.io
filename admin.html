<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FUNLET ì–´ë“œë¯¼ V9 - Masterpiece</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --sidebar-w: 260px; --primary: #00ff9d; --bg: #121212; --panel: #1e1e1e; --danger: #ff4757; }
        body { margin: 0; background: var(--bg); color: #fff; font-family: 'Noto Sans KR'; display: flex; height: 100vh; overflow: hidden; }
        
        /* ì‚¬ì´ë“œë°” */
        .sidebar { width: var(--sidebar-w); background: #1a1a1a; border-right: 1px solid #333; display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; flex-shrink: 0; }
        .logo { font-size: 1.5rem; color: var(--primary); font-weight: bold; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
        .menu-item { padding: 15px; color: #aaa; cursor: pointer; border-radius: 10px; margin-bottom: 5px; transition: 0.2s; display: flex; align-items: center; gap: 10px; font-weight: 500; }
        .menu-item:hover, .menu-item.active { background: rgba(0, 255, 157, 0.1); color: var(--primary); }
        
        /* ì»¨í…ì¸  */
        .content { flex: 1; padding: 40px; overflow-y: auto; background: var(--bg); position: relative; }
        .page { display: none; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h2 { border-bottom: 2px solid #333; padding-bottom: 15px; margin-top: 0; color: var(--primary); display: flex; justify-content: space-between; align-items: center; }
        
        /* í¼ ìš”ì†Œ */
        .card { background: #222; padding: 20px; border-radius: 10px; border: 1px solid #333; margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #ccc; font-size: 0.9rem; }
        input, select, textarea { width: 100%; padding: 12px; background: #111; border: 1px solid #444; color: white; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px; font-family: inherit; }
        input:focus, select:focus { border-color: var(--primary); outline: none; }
        
        /* ë²„íŠ¼ */
        button { padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; border: none; font-size: 0.9rem; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: black; width: 100%; padding: 15px; font-size: 1.1rem; }
        .btn-primary:hover { background: #00cc7d; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; width: auto; }
        
        /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ (ì¹´í…Œê³ ë¦¬/ê²Œì„ ëª©ë¡) */
        .list-row { display: flex; gap: 10px; align-items: center; background: #2a2a2a; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #333; }
        .list-row input { margin-bottom: 0; background: #1a1a1a; border: 1px solid #444; }
        
        /* íŒŒì¼ ê·¸ë¦¬ë“œ (ìì‚° ê´€ë¦¬) */
        .file-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; margin-top: 15px; }
        .file-card { background: #2a2a2a; border: 1px solid #444; border-radius: 10px; padding: 10px; text-align: center; cursor: pointer; transition: 0.2s; position: relative; }
        .file-card:hover { border-color: var(--primary); transform: translateY(-3px); }
        .file-card img { width: 100%; height: 80px; object-fit: contain; background: #000; border-radius: 5px; margin-bottom: 5px; }
        .file-name { font-size: 0.75rem; color: #ddd; word-break: break-all; }
        .file-type-audio { display: flex; align-items: center; justify-content: center; height: 80px; background: #333; border-radius: 5px; margin-bottom: 5px; color: #aaa; font-size: 2rem; }

        .loading { text-align: center; color: #888; padding: 20px; }
        .badge { background: #333; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; color: #aaa; margin-left: 10px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo"><i class="fa-solid fa-gamepad"></i> FUNLET ADMIN</div>
        
        <div class="menu-item active" onclick="goPage('category')"><i class="fa-solid fa-list"></i> ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</div>
        <div class="menu-item" onclick="goPage('game')"><i class="fa-solid fa-chess-board"></i> ê²Œì„ ê´€ë¦¬</div>
        <div class="menu-item" onclick="goPage('assets')"><i class="fa-solid fa-folder-open"></i> ìì‚°(ì´ë¯¸ì§€/ì†Œë¦¬)</div>
        <div class="menu-item" onclick="goPage('link')"><i class="fa-solid fa-link"></i> ë°°ë„ˆ ë§í¬</div>

        <div style="margin-top:auto;">
            <label>ğŸ”‘ ê´€ë¦¬ì í† í°</label>
            <input type="password" id="token" placeholder="ghp_..." onchange="saveToken()">
            <button onclick="loadAllData()" class="btn-primary" style="margin-top:10px; background:#444; color:white; font-size:0.9rem;">ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
        </div>
    </div>

    <div class="content">

        <div id="page-category" class="page active">
            <h2>ğŸ“‚ ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ <button class="btn-sm" style="background:#444; color:white;" onclick="addCategoryRow()">+ ì¶”ê°€</button></h2>
            <p style="color:#aaa; font-size:0.9rem; margin-bottom:20px;">* ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ìˆ˜ì •í•˜ê±°ë‚˜ ìˆœì„œë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            
            <div id="categoryList">
                <div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
            <button class="btn-primary" onclick="saveCategories()">ì¹´í…Œê³ ë¦¬ ë³€ê²½ì‚¬í•­ ì €ì¥</button>
        </div>

        <div id="page-game" class="page">
            <h2>ğŸ® ê²Œì„ ê´€ë¦¬ / ìˆ˜ì •</h2>
            
            <div class="card">
                <h3>âœï¸ ê²Œì„ ì •ë³´ ìˆ˜ì • & ì‹ ê·œ ìƒì„±</h3>
                <div class="form-group">
                    <label>ê²Œì„ ì„ íƒ (ìˆ˜ì • ì‹œ ì„ íƒ, ì‹ ê·œëŠ” ë¹„ì›Œë‘ )</label>
                    <select id="gameSelector" onchange="selectGameForEdit()">
                        <option value="">-- ì‹ ê·œ ê²Œì„ ë§Œë“¤ê¸° --</option>
                    </select>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <div>
                        <label>ê²Œì„ ID (í´ë”ëª…, ìˆ˜ì •ë¶ˆê°€)</label>
                        <input type="text" id="gId" placeholder="ì˜ˆ: space-merge">
                    </div>
                    <div>
                        <label>ê²Œì„ ì œëª©</label>
                        <input type="text" id="gTitle" placeholder="ì˜ˆ: ìš°ì£¼ í•©ì¹˜ê¸°">
                    </div>
                </div>

                <label>ì¹´í…Œê³ ë¦¬ ì„ íƒ</label>
                <select id="gCategory">
                    <option>ì¹´í…Œê³ ë¦¬ ë¡œë”© ì¤‘...</option>
                </select>

                <div style="display:flex; gap:10px; align-items:center; margin-top:10px;">
                    <div style="flex:1">
                        <label>ì¸ë„¤ì¼ ì´ë¯¸ì§€</label>
                        <input type="text" id="gThumbPath" placeholder="ì´ë¯¸ì§€ ê²½ë¡œ ìë™ ì…ë ¥ë¨" readonly style="background:#222; color:#777;">
                    </div>
                    <button onclick="alert('ìì‚° ê´€ë¦¬ íƒ­ì—ì„œ ì¸ë„¤ì¼ì„ ì—…ë¡œë“œí•˜ê³  ê²½ë¡œë¥¼ ë³µì‚¬í•´ì˜¤ì„¸ìš”!')" style="height:42px; margin-top:18px; background:#444; color:white;">ê²½ë¡œ ì°¾ê¸°</button>
                </div>

                <button class="btn-primary" onclick="saveGameData()" style="margin-top:20px;">ê²Œì„ ì •ë³´ ì €ì¥ (games.json)</button>
            </div>
        </div>

        <div id="page-assets" class="page">
            <h2>ğŸ–¼ï¸ ìì‚° ë° íŒŒì¼ ê´€ë¦¬</h2>
            
            <div class="card">
                <label>ğŸ“‚ í´ë” ì„ íƒ</label>
                <div style="display:flex; gap:10px;">
                    <select id="folderSelect" onchange="loadFiles(this.value)" style="flex:1;">
                        <option value="">í† í° ì…ë ¥ í›„ ìƒˆë¡œê³ ì¹¨ í•˜ì„¸ìš”</option>
                    </select>
                    <button onclick="scanFolders()" style="background:#444; color:white; width:100px;">ğŸ”„ ìŠ¤ìº”</button>
                </div>
            </div>

            <div class="card" id="uploadArea" style="display:none;">
                <h3 style="margin-top:0;">ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ / êµì²´</h3>
                <p style="font-size:0.9rem; color:#aaa;">íŒŒì¼ì„ ì„ íƒí•˜ë©´ í˜„ì¬ í´ë”ì— ì—…ë¡œë“œë©ë‹ˆë‹¤. (ê°™ì€ ì´ë¦„ì´ë©´ ë®ì–´ì“°ê¸°)</p>
                
                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="text" id="uploadName" placeholder="íŒŒì¼ëª… (ì˜ˆ: player.png)" style="flex:1;">
                    <input type="file" id="uploadFile" style="flex:1;">
                </div>
                <button class="btn-primary" onclick="uploadAsset()" style="margin-top:10px;">ì„œë²„ì— ì „ì†¡í•˜ê¸°</button>
            </div>

            <div id="fileGrid" class="file-grid"></div>
        </div>

        <div id="page-link" class="page">
            <h2>ğŸ”— ë°°ë„ˆ ë§í¬ ê´€ë¦¬</h2>
            <div id="linkList">ë¡œë”© ì¤‘...</div>
            <button class="btn-primary" onclick="saveLinks()" style="margin-top:20px;">ë§í¬ ì €ì¥í•˜ê¸°</button>
        </div>

    </div>

    <script>
        const USER = 'fun-let';
        const REPO = 'funlet';
        let categories = [];
        let games = [];
        let catsSha = null;
        let gamesSha = null;
        let adsData = {};
        let adsSha = null;
        let currentPath = "";

        // ì´ˆê¸°í™”
        window.onload = () => {
            const t = localStorage.getItem('token');
            if(t) { document.getElementById('token').value = t; loadAllData(); }
        }
        function saveToken() { localStorage.setItem('token', document.getElementById('token').value); loadAllData(); }
        
        function goPage(page) {
            document.querySelectorAll('.menu-item').forEach(e=>e.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.querySelectorAll('.page').forEach(e=>e.classList.remove('active'));
            document.getElementById('page-'+page).classList.add('active');
        }

        // í†µí•© ë°ì´í„° ë¡œë“œ
        async function loadAllData() {
            const token = document.getElementById('token').value;
            if(!token) return;

            // 1. ì¹´í…Œê³ ë¦¬ ë¡œë“œ
            try {
                let res = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/data/categories.json`, {headers:{Authorization:`token ${token}`}});
                let d = await res.json();
                catsSha = d.sha;
                categories = JSON.parse(new TextDecoder().decode(Uint8Array.from(atob(d.content), c=>c.charCodeAt(0))));
                renderCategories();
                updateCategoryDropdowns();
            } catch(e) { console.log("ì¹´í…Œê³ ë¦¬ ë¡œë“œ ì‹¤íŒ¨ (íŒŒì¼ ì—†ìŒ?)"); }

            // 2. ê²Œì„ ë¡œë“œ
            try {
                let res = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/data/games.json`, {headers:{Authorization:`token ${token}`}});
                let d = await res.json();
                gamesSha = d.sha;
                games = JSON.parse(new TextDecoder().decode(Uint8Array.from(atob(d.content), c=>c.charCodeAt(0))));
                updateGameSelector();
            } catch(e) { console.log("ê²Œì„ ë¡œë“œ ì‹¤íŒ¨"); }

            // 3. í´ë” ìŠ¤ìº”
            scanFolders();
            
            // 4. ë°°ë„ˆ ë§í¬ ë¡œë“œ
            loadLinks();
        }

        // --- 1. ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ ê¸°ëŠ¥ ---
        function renderCategories() {
            const list = document.getElementById('categoryList');
            list.innerHTML = "";
            categories.forEach((cat, idx) => {
                list.innerHTML += `
                    <div class="list-row">
                        <input type="text" value="${cat.id}" placeholder="ID (ì˜ì–´)" style="width:20%;" onchange="categories[${idx}].id=this.value">
                        <input type="text" value="${cat.name}" placeholder="ì´ë¦„ (í•œê¸€)" style="width:40%;" onchange="categories[${idx}].name=this.value">
                        <input type="text" value="${cat.icon}" placeholder="ì•„ì´ì½˜ í´ë˜ìŠ¤" style="width:30%;" onchange="categories[${idx}].icon=this.value">
                        <button class="btn-danger btn-sm" onclick="deleteCategory(${idx})">ì‚­ì œ</button>
                    </div>`;
            });
        }
        function addCategoryRow() {
            categories.push({id:"", name:"", icon:"fa-solid fa-gamepad"});
            renderCategories();
        }
        function deleteCategory(idx) {
            if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { categories.splice(idx, 1); renderCategories(); }
        }
        async function saveCategories() {
            await uploadFile('data/categories.json', JSON.stringify(categories, null, 2), catsSha, "Update Categories");
            alert("ì¹´í…Œê³ ë¦¬ ì €ì¥ ì™„ë£Œ! ë©”ì¸ë©”ë‰´ì— ë°”ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.");
            loadAllData();
        }

        // --- 2. ê²Œì„ ê´€ë¦¬ ê¸°ëŠ¥ ---
        function updateCategoryDropdowns() {
            const sel = document.getElementById('gCategory');
            sel.innerHTML = "";
            categories.forEach(c => {
                sel.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });
        }
        function updateGameSelector() {
            const sel = document.getElementById('gameSelector');
            sel.innerHTML = '<option value="">-- ì‹ ê·œ ê²Œì„ ë§Œë“¤ê¸° --</option>';
            games.forEach((g, idx) => {
                sel.innerHTML += `<option value="${idx}">[ìˆ˜ì •] ${g.title} (${g.id})</option>`;
            });
        }
        function selectGameForEdit() {
            const idx = document.getElementById('gameSelector').value;
            if(idx === "") {
                // ì‹ ê·œ ëª¨ë“œ ì´ˆê¸°í™”
                document.getElementById('gId').value = "";
                document.getElementById('gId').disabled = false;
                document.getElementById('gTitle').value = "";
                document.getElementById('gThumbPath').value = "";
            } else {
                // ìˆ˜ì • ëª¨ë“œ
                const g = games[idx];
                document.getElementById('gId').value = g.id;
                document.getElementById('gId').disabled = true; // ID ìˆ˜ì • ë¶ˆê°€
                document.getElementById('gTitle').value = g.title;
                document.getElementById('gCategory').value = g.category;
                document.getElementById('gThumbPath').value = g.thumb;
            }
        }
        async function saveGameData() {
            const id = document.getElementById('gId').value;
            const title = document.getElementById('gTitle').value;
            const catId = document.getElementById('gCategory').value;
            const thumb = document.getElementById('gThumbPath').value;
            
            if(!id || !title) return alert("IDì™€ ì œëª©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");

            // ì¹´í…Œê³ ë¦¬ ì´ë¦„ ì°¾ê¸° (ì„¤ëª…ìš©)
            const catName = categories.find(c => c.id === catId)?.name || "ê¸°íƒ€";

            const newEntry = {
                id: id, title: title, category: catId,
                desc: catName, thumb: thumb
            };

            const idx = games.findIndex(g => g.id === id);
            if(idx > -1) games[idx] = newEntry; // ìˆ˜ì •
            else games.push(newEntry); // ì‹ ê·œ

            await uploadFile('data/games.json', JSON.stringify(games, null, 2), gamesSha, "Update Games");
            alert("ê²Œì„ ì •ë³´ ì €ì¥ ì™„ë£Œ!");
            loadAllData();
        }

        // --- 3. ìì‚° ê´€ë¦¬ (ì‹œê°ì  ë¸Œë¼ìš°ì €) ---
        async function scanFolders() {
            const token = document.getElementById('token').value;
            const sel = document.getElementById('folderSelect');
            sel.innerHTML = '<option>ìŠ¤ìº” ì¤‘...</option>';
            try {
                // imagesì™€ audio í´ë” ìŠ¤ìº”
                const dirs = ['images', 'audio'];
                sel.innerHTML = '<option value="">-- í´ë”ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>';
                
                for(let d of dirs) {
                    let res = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/${d}`, {headers:{Authorization:`token ${token}`}});
                    let data = await res.json();
                    sel.innerHTML += `<option value="${d}/">ğŸ“‚ ${d}/ (ë£¨íŠ¸)</option>`;
                    data.forEach(item => {
                        if(item.type === 'dir') sel.innerHTML += `<option value="${item.path}/">   â”” ${item.name}/</option>`;
                    });
                }
            } catch(e) { console.error(e); }
        }

        async function loadFiles(path) {
            if(!path) return;
            currentPath = path;
            const token = document.getElementById('token').value;
            const grid = document.getElementById('fileGrid');
            const upArea = document.getElementById('uploadArea');
            
            grid.innerHTML = '<div class="loading">ë¡œë”© ì¤‘...</div>';
            upArea.style.display = 'block';

            try {
                const res = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/${path}`, {headers:{Authorization:`token ${token}`}});
                const data = await res.json();
                grid.innerHTML = '';
                
                if(data.length === 0) grid.innerHTML = '<div class="loading">íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';

                data.forEach(item => {
                    if(item.type === 'file') {
                        const div = document.createElement('div');
                        div.className = 'file-card';
                        
                        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
                        if(item.name.match(/\.(png|jpg|jpeg|gif)$/i)) {
                            div.innerHTML = `<img src="${item.download_url}?t=${Date.now()}"><div class="file-name">${item.name}</div>`;
                        } else {
                            div.innerHTML = `<div class="file-type-audio"><i class="fa-solid fa-file-audio"></i></div><div class="file-name">${item.name}</div>`;
                        }
                        
                        div.onclick = () => {
                            document.getElementById('uploadName').value = item.name;
                            // ê²½ë¡œ ë³µì‚¬ (ê²Œì„ ì„¤ì •ìš©)
                            if(confirm(`ê²½ë¡œë¥¼ ë³µì‚¬í• ê¹Œìš”?\n${item.path}`)) {
                                navigator.clipboard.writeText(item.path);
                                alert("ê²½ë¡œ ë³µì‚¬ë¨! ê²Œì„ ê´€ë¦¬ íƒ­ì—ì„œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.");
                            }
                        };
                        grid.appendChild(div);
                    }
                });
            } catch(e) { grid.innerHTML = 'ë¡œë“œ ì‹¤íŒ¨'; }
        }

        async function uploadAsset() {
            const name = document.getElementById('uploadName').value;
            const file = document.getElementById('uploadFile').files[0];
            if(!name || !file) return alert("íŒŒì¼ëª…ê³¼ íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.");
            
            const reader = new FileReader();
            reader.onload = async function() {
                const content = reader.result.split(',')[1];
                // ê¸°ì¡´ SHA ì²´í¬
                let sha = null;
                try {
                    let res = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/${currentPath}${name}`, {headers:{Authorization:`token ${document.getElementById('token').value}`}});
                    if(res.ok) sha = (await res.json()).sha;
                } catch(e){}
                
                await uploadRawFile(currentPath + name, content, sha);
                alert("ì—…ë¡œë“œ ì„±ê³µ!");
                loadFiles(currentPath);
            };
            reader.readAsDataURL(file);
        }

        // --- 4. ë§í¬ ê´€ë¦¬ ---
        async function loadLinks() {
            const token = document.getElementById('token').value;
            const list = document.getElementById('linkList');
            try {
                let res = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/data/ads.json`, {headers:{Authorization:`token ${token}`}});
                let d = await res.json();
                adsSha = d.sha;
                adsData = JSON.parse(new TextDecoder().decode(Uint8Array.from(atob(d.content), c=>c.charCodeAt(0))));
                
                list.innerHTML = "";
                for(const [k,v] of Object.entries(adsData)) {
                    list.innerHTML += `<div class="list-row"><span class="link-key">${k}</span><input type="text" id="lnk-${k}" value="${v.link}" style="width:70%;"></div>`;
                }
            } catch(e){ list.innerHTML = "ë¡œë“œ ì‹¤íŒ¨"; }
        }
        async function saveLinks() {
            for(const k of Object.keys(adsData)) adsData[k].link = document.getElementById(`lnk-${k}`).value;
            await uploadFile('data/ads.json', JSON.stringify(adsData, null, 2), adsSha, "Update Links");
            alert("ë§í¬ ì €ì¥ ì™„ë£Œ!");
            loadLinks(); // SHA ê°±ì‹ 
        }

        // --- API ìœ í‹¸ ---
        async function uploadFile(path, content, sha, msg) {
            const token = document.getElementById('token').value;
            const body = { message: msg, content: btoa(unescape(encodeURIComponent(content))) };
            if(sha) body.sha = sha;
            await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/${path}`, {
                method: 'PUT', headers: {'Authorization':`token ${token}`}, body: JSON.stringify(body)
            });
        }
        async function uploadRawFile(path, base64, sha) {
            const token = document.getElementById('token').value;
            const body = { message: "Upload asset", content: base64 };
            if(sha) body.sha = sha;
            await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/${path}`, {
                method: 'PUT', headers: {'Authorization':`token ${token}`}, body: JSON.stringify(body)
            });
        }
    </script>
</body>
</html>
