<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FUNLET Admin V7 - Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --sidebar-w: 260px; --primary: #00ff9d; --bg: #121212; --panel: #1e1e1e; }
        body { margin: 0; background: var(--bg); color: #fff; font-family: 'Noto Sans KR'; display: flex; height: 100vh; overflow: hidden; }
        
        /* ì™¼ìª½ ì‚¬ì´ë“œë°” */
        .sidebar { width: var(--sidebar-w); background: #1a1a1a; border-right: 1px solid #333; display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; }
        .logo { font-size: 1.5rem; color: var(--primary); font-weight: bold; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .menu-item { padding: 15px; color: #aaa; cursor: pointer; border-radius: 10px; margin-bottom: 5px; transition: 0.2s; display: flex; align-items: center; gap: 10px; }
        .menu-item:hover, .menu-item.active { background: rgba(0, 255, 157, 0.1); color: var(--primary); }
        .token-area { margin-top: auto; border-top: 1px solid #333; padding-top: 20px; }
        .token-input { width: 100%; background: #000; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 5px; box-sizing: border-box; font-size: 0.8rem; }

        /* ì˜¤ë¥¸ìª½ ì»¨í…ì¸  */
        .content { flex: 1; padding: 40px; overflow-y: auto; background: var(--bg); }
        .page { display: none; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h2 { border-bottom: 2px solid #333; padding-bottom: 15px; margin-top: 0; color: var(--primary); }
        
        /* í¼ ìŠ¤íƒ€ì¼ */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-full { grid-column: span 2; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #ccc; font-size: 0.9rem; }
        input, select, textarea { width: 100%; padding: 12px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 8px; box-sizing: border-box; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); outline: none; }
        textarea { height: 150px; font-family: monospace; line-height: 1.4; }
        
        .helper { font-size: 0.8rem; color: #666; margin-top: 5px; }
        
        /* ë²„íŠ¼ */
        .btn-primary { width: 100%; padding: 15px; background: var(--primary); color: black; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1.1rem; }
        .btn-primary:hover { filter: brightness(1.1); }
        
        /* ë¡œê·¸ ì°½ */
        .log-box { background: #000; padding: 15px; border-radius: 8px; border: 1px solid #333; color: #00ff9d; font-family: monospace; height: 150px; overflow-y: auto; margin-top: 20px; font-size: 0.9rem; }

        /* íŒŒì¼ ë¦¬ìŠ¤íŠ¸ (ë°°ë„ˆ ê´€ë¦¬ìš©) */
        .file-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }
        .file-card { background: #2a2a2a; padding: 10px; border-radius: 10px; text-align: center; cursor: pointer; border: 1px solid #444; }
        .file-card:hover { border-color: var(--primary); }
        .file-card img { width: 100%; height: 80px; object-fit: contain; background: #000; margin-bottom: 10px; }
        .file-name { font-size: 0.8rem; color: #ddd; word-break: break-all; }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="logo"><i class="fa-solid fa-rocket"></i> FUNLET ADMIN</div>
        
        <div class="menu-item active" onclick="showPage('game-studio')">
            <i class="fa-solid fa-gamepad"></i> ê²Œì„ ìŠ¤íŠœë””ì˜¤
        </div>
        <div class="menu-item" onclick="showPage('asset-center')">
            <i class="fa-solid fa-images"></i> ìì‚°/ë°°ë„ˆ ê´€ë¦¬
        </div>
        <div class="menu-item" onclick="showPage('link-manager')">
            <i class="fa-solid fa-link"></i> ë§í¬ ì—°ê²°
        </div>

        <div class="token-area">
            <label>ğŸ”‘ ê´€ë¦¬ì í† í°</label>
            <input type="password" id="token" class="token-input" placeholder="ghp_..." onchange="saveToken()">
        </div>
    </nav>

    <div class="content">
        
        <div id="game-studio" class="page active">
            <h2>ğŸ® ìƒˆ ê²Œì„ ì¶œì‹œí•˜ê¸°</h2>
            <p style="color:#888; margin-bottom:20px;">ì½”ë“œì™€ í•„ìš”í•œ ì´ë¯¸ì§€/ìŒì›ì„ í•œ ë²ˆì— ì—…ë¡œë“œí•©ë‹ˆë‹¤.</p>

            <div class="form-grid">
                <div class="form-group">
                    <label>1. ê²Œì„ ID (ì˜ì–´ ì†Œë¬¸ì)</label>
                    <input type="text" id="gId" placeholder="ì˜ˆ: jump-king">
                    <div class="helper">* í´ë”ëª…ì´ ë©ë‹ˆë‹¤ (ë„ì–´ì“°ê¸° ê¸ˆì§€)</div>
                </div>
                <div class="form-group">
                    <label>2. ê²Œì„ ì œëª© (í•œê¸€ ê°€ëŠ¥)</label>
                    <input type="text" id="gTitle" placeholder="ì˜ˆ: ì í”„ í‚¹">
                </div>
                <div class="form-group">
                    <label>3. ì¹´í…Œê³ ë¦¬ (ì§ì ‘ ì…ë ¥ ê°€ëŠ¥)</label>
                    <div style="display:flex; gap:10px;">
                        <select id="gCatSelect" onchange="document.getElementById('gCatInput').value=this.value">
                            <option value="idle">í‚¤ìš°ê¸°/IDLE</option>
                            <option value="simulation">ì‹œë®¬ë ˆì´ì…˜</option>
                            <option value="action">ì•¡ì…˜/ì•„ì¼€ì´ë“œ</option>
                            <option value="social">ì†Œì…œ/ì‹¬ë¦¬</option>
                            <option value="puzzle">í¼ì¦</option>
                        </select>
                        <input type="text" id="gCatInput" placeholder="ì§ì ‘ ì…ë ¥" value="idle">
                    </div>
                </div>
                <div class="form-group">
                    <label>4. ëŒ€í‘œ ì¸ë„¤ì¼ ì´ë¯¸ì§€</label>
                    <input type="file" id="gThumb" accept="image/*">
                </div>
                
                <div class="form-group form-full">
                    <label>5. ê²Œì„ ìì‚° ì¶”ê°€ (ì´ë¯¸ì§€ & ì˜¤ë””ì˜¤)</label>
                    <input type="file" id="gAssets" multiple>
                    <div class="helper">* ê²Œì„ì— ë“¤ì–´ê°€ëŠ” ìºë¦­í„°(png), ë°°ê²½, íš¨ê³¼ìŒ(mp3) ë“±ì„ ëª¨ë‘ ì„ íƒí•˜ì„¸ìš”. ìë™ìœ¼ë¡œ í´ë”ì— ì •ë¦¬ë©ë‹ˆë‹¤.</div>
                </div>

                <div class="form-group form-full">
                    <label>6. HTML ì½”ë“œ ë¶™ì—¬ë„£ê¸°</label>
                    <textarea id="gCode" placeholder="<!DOCTYPE html>..."></textarea>
                </div>
            </div>

            <button class="btn-primary" onclick="createGameFull()">ğŸš€ ê²Œì„ ìƒì„± ë° ë°°í¬ ì‹œì‘</button>
            <div id="studioLog" class="log-box" style="display:none;"></div>
        </div>

        <div id="asset-center" class="page">
            <h2>ğŸ–¼ï¸ ìì‚° ë° ë°°ë„ˆ ê´€ë¦¬</h2>
            
            <div class="form-group">
                <label>ğŸ“‚ í´ë” ì„ íƒ</label>
                <select id="folderSelect" onchange="loadFolderFiles(this.value)">
                    <option value="">í† í° í™•ì¸ ì¤‘...</option>
                </select>
                <button onclick="scanFolders()" style="margin-top:5px; background:#333; color:white; border:1px solid #555; padding:5px 10px; cursor:pointer;">ğŸ”„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
            </div>

            <div class="form-group">
                <label>ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ (ë®ì–´ì“°ê¸° or ì‹ ê·œ)</label>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="uploadFileName" placeholder="íŒŒì¼ëª… (ì˜ˆ: banner_main_pc.png)" style="flex:1;">
                    <input type="file" id="uploadFileObj" style="flex:1;">
                </div>
                <button onclick="uploadSingleFile()" style="margin-top:10px; width:100%; padding:10px; background:#444; color:white; border:none; cursor:pointer;">ì„ íƒí•œ ì´ë¦„ìœ¼ë¡œ ì—…ë¡œë“œ</button>
            </div>

            <div id="fileGrid" class="file-list">
                <div style="color:#666; padding:20px;">í´ë”ë¥¼ ì„ íƒí•˜ë©´ íŒŒì¼ì´ ë³´ì…ë‹ˆë‹¤.</div>
            </div>
        </div>

        <div id="link-manager" class="page">
            <h2>ğŸ”— ë°°ë„ˆ ì—°ê²° ì£¼ì†Œ ê´€ë¦¬</h2>
            <p style="color:#888;">ads.json íŒŒì¼ì„ ìˆ˜ì •í•˜ì—¬ ë°°ë„ˆ í´ë¦­ ì‹œ ì´ë™í•  ì£¼ì†Œë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.</p>
            <div id="linkList">ë¡œë”© ì¤‘...</div>
            <button class="btn-primary" onclick="saveLinks()" style="margin-top:20px;">ë³€ê²½ì‚¬í•­ ì €ì¥</button>
        </div>

    </div>

    <script>
        const USER = 'fun-let';
        const REPO = 'funlet';
        let currentAdsData = {};
        let adsSha = null;

        // ì´ˆê¸°í™”
        window.onload = () => {
            const t = localStorage.getItem('github_token');
            if(t) { document.getElementById('token').value = t; scanFolders(); }
        }
        function saveToken() { localStorage.setItem('github_token', document.getElementById('token').value); scanFolders(); }
        function showPage(id) {
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'link-manager') loadLinks();
        }
        function log(msg) { 
            const box = document.getElementById('studioLog'); 
            box.style.display='block'; 
            box.innerHTML += `> ${msg}<br>`; 
            box.scrollTop = box.scrollHeight;
        }

        // ==========================================
        // 1. ê²Œì„ ìŠ¤íŠœë””ì˜¤ (ì˜¬ì¸ì› ìƒì„±)
        // ==========================================
        async function createGameFull() {
            const token = document.getElementById('token').value;
            const id = document.getElementById('gId').value.trim();
            const title = document.getElementById('gTitle').value;
            const cat = document.getElementById('gCatInput').value;
            const code = document.getElementById('gCode').value;
            const thumb = document.getElementById('gThumb').files[0];
            const assets = document.getElementById('gAssets').files;

            if(!token || !id || !title || !code || !thumb) { alert("í•„ìˆ˜ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”."); return; }

            document.getElementById('studioLog').innerHTML = "";
            log("ì‘ì—…ì„ ì‹œì‘í•©ë‹ˆë‹¤...");

            try {
                // 1. ì¸ë„¤ì¼ ì—…ë¡œë“œ
                log("ì¸ë„¤ì¼ ì—…ë¡œë“œ ì¤‘...");
                await uploadFileAPI(token, `images/thumbnails/${id}_thumb.jpg`, thumb);

                // 2. ì¶”ê°€ ìì‚°(ì´ë¯¸ì§€/ì˜¤ë””ì˜¤) ì—…ë¡œë“œ
                if(assets.length > 0) {
                    log(`ì¶”ê°€ ìì‚° ${assets.length}ê°œ ì—…ë¡œë“œ ì‹œì‘...`);
                    for(let file of assets) {
                        let path = "";
                        // í™•ì¥ìë¡œ í´ë” êµ¬ë¶„ (ì´ë¯¸ì§€ëŠ” images/ê²Œì„ID, ì†Œë¦¬ëŠ” audio/ê²Œì„ID)
                        if(file.type.startsWith('audio')) path = `audio/${id}/${file.name}`;
                        else path = `images/${id}/${file.name}`;
                        
                        log(`Uploading: ${file.name} -> ${path}`);
                        await uploadFileAPI(token, path, file);
                    }
                }

                // 3. HTML ì½”ë“œ ì—…ë¡œë“œ
                log("ê²Œì„ ì½”ë“œ ìƒì„± ì¤‘...");
                const codeBlob = new Blob([code], { type: 'text/html' });
                await uploadFileAPI(token, `games/${id}/index.html`, codeBlob);

                // 4. games.json ê°±ì‹ 
                log("ê²Œì„ ëª©ë¡ ì¥ë¶€(DB) ì—…ë°ì´íŠ¸ ì¤‘...");
                const jsonUrl = `https://api.github.com/repos/${USER}/${REPO}/contents/data/games.json`;
                const jsonRes = await fetch(jsonUrl, { headers: { Authorization: `token ${token}` } });
                const jsonData = await jsonRes.json();
                
                // ë””ì½”ë”© -> ë°°ì—´ ì¶”ê°€ -> ì¸ì½”ë”©
                const currentGames = JSON.parse(new TextDecoder().decode(Uint8Array.from(atob(jsonData.content), c => c.charCodeAt(0))));
                
                // ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸ (ì¤‘ë³µ ë°©ì§€)
                const existsIdx = currentGames.findIndex(g => g.id === id);
                const newEntry = {
                    id: id,
                    title: title,
                    category: cat,
                    desc: cat.toUpperCase() + " Game",
                    thumb: `images/thumbnails/${id}_thumb.jpg`
                };

                if(existsIdx > -1) currentGames[existsIdx] = newEntry; // ì—…ë°ì´íŠ¸
                else currentGames.push(newEntry); // ì‹ ê·œ ì¶”ê°€

                // JSON ì—…ë¡œë“œ
                const newJsonStr = JSON.stringify(currentGames, null, 2);
                const newJsonBlob = new Blob([newJsonStr], { type: 'application/json' });
                await uploadFileAPI(token, 'data/games.json', newJsonBlob, jsonData.sha);

                log("ğŸ‰ <b style='color:#00ff9d'>ëª¨ë“  ì‘ì—… ì™„ë£Œ! ì‚¬ì´íŠ¸ê°€ ê³§ ê°±ì‹ ë©ë‹ˆë‹¤.</b>");
                alert("ê²Œì„ ìƒì„± ì„±ê³µ!");

            } catch(e) {
                log(`<span style='color:red'>ì˜¤ë¥˜ ë°œìƒ: ${e.message}</span>`);
            }
        }

        // ==========================================
        // 2. ìì‚° ì„¼í„° (íŒŒì¼ ë¸Œë¼ìš°ì €)
        // ==========================================
        async function scanFolders() {
            const token = document.getElementById('token').value;
            const select = document.getElementById('folderSelect');
            select.innerHTML = '<option>ìŠ¤ìº” ì¤‘...</option>';
            try {
                // images í´ë” ìŠ¤ìº”
                const url = `https://api.github.com/repos/${USER}/${REPO}/contents/images`;
                const res = await fetch(url, { headers: { Authorization: `token ${token}` } });
                const data = await res.json();
                select.innerHTML = '<option value="">-- í´ë” ì„ íƒ --</option>';
                select.innerHTML += '<option value="images/">images/ (ê¸°ë³¸)</option>';
                data.forEach(item => { if(item.type === 'dir') select.innerHTML += `<option value="${item.path}/">${item.path}/</option>`; });
            } catch(e) { console.error(e); }
        }

        async function loadFolderFiles(path) {
            if(!path) return;
            const token = document.getElementById('token').value;
            const grid = document.getElementById('fileGrid');
            grid.innerHTML = 'ë¡œë”© ì¤‘...';
            
            try {
                const url = `https://api.github.com/repos/${USER}/${REPO}/contents/${path}`;
                const res = await fetch(url, { headers: { Authorization: `token ${token}` } });
                const data = await res.json();
                grid.innerHTML = '';
                data.forEach(item => {
                    if(item.type === 'file' && item.name.match(/\.(png|jpg|jpeg|gif)$/i)) {
                        const div = document.createElement('div');
                        div.className = 'file-card';
                        div.innerHTML = `<img src="${item.download_url}?t=${Date.now()}"><div class="file-name">${item.name}</div>`;
                        div.onclick = () => { document.getElementById('uploadFileName').value = item.name; };
                        grid.appendChild(div);
                    }
                });
            } catch(e) { grid.innerHTML = 'ë¡œë“œ ì‹¤íŒ¨'; }
        }

        async function uploadSingleFile() {
            const token = document.getElementById('token').value;
            const folder = document.getElementById('folderSelect').value;
            const name = document.getElementById('uploadFileName').value;
            const file = document.getElementById('uploadFileObj').files[0];
            
            if(!folder || !name || !file) { alert("ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }
            if(!confirm(`${folder}${name} ê²½ë¡œì— íŒŒì¼ì„ ì—…ë¡œë“œí•©ë‹ˆë‹¤.`)) return;

            try {
                await uploadFileAPI(token, `${folder}${name}`, file);
                alert("ì—…ë¡œë“œ ì„±ê³µ!");
                loadFolderFiles(folder);
            } catch(e) { alert("ì‹¤íŒ¨: " + e.message); }
        }

        // ==========================================
        // 3. ë§í¬ ë§¤ë‹ˆì € (JSON ìˆ˜ì •)
        // ==========================================
        async function loadLinks() {
            const token = document.getElementById('token').value;
            const div = document.getElementById('linkList');
            div.innerHTML = 'ë¡œë”© ì¤‘...';
            try {
                const url = `https://api.github.com/repos/${USER}/${REPO}/contents/data/ads.json`;
                const res = await fetch(url, { headers: { Authorization: `token ${token}` } });
                const data = await res.json();
                adsSha = data.sha;
                currentAdsData = JSON.parse(new TextDecoder().decode(Uint8Array.from(atob(data.content), c => c.charCodeAt(0))));
                
                div.innerHTML = '';
                for(const [k, v] of Object.entries(currentAdsData)) {
                    div.innerHTML += `
                        <div style="margin-bottom:10px; background:#222; padding:10px; border-radius:5px;">
                            <div style="color:var(--primary); font-weight:bold; margin-bottom:5px;">${k}</div>
                            <input type="text" id="lnk-${k}" value="${v.link||'#'}" style="width:100%;">
                        </div>
                    `;
                }
            } catch(e) { div.innerHTML = 'ë¡œë“œ ì‹¤íŒ¨'; }
        }

        async function saveLinks() {
            const token = document.getElementById('token').value;
            for(const k of Object.keys(currentAdsData)) {
                currentAdsData[k].link = document.getElementById(`lnk-${k}`).value;
            }
            const blob = new Blob([JSON.stringify(currentAdsData, null, 2)], { type: 'application/json' });
            try {
                await uploadFileAPI(token, 'data/ads.json', blob, adsSha);
                alert("ë§í¬ ì €ì¥ ì™„ë£Œ!");
                loadLinks(); // SHA ê°±ì‹ 
            } catch(e) { alert("ì‹¤íŒ¨"); }
        }

        // ==========================================
        // ê³µí†µ API í•¨ìˆ˜ (ê°€ì¥ ì¤‘ìš”)
        // ==========================================
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        async function uploadFileAPI(token, path, fileBlob, sha = null) {
            // 1. ê¸°ì¡´ íŒŒì¼ ìˆëŠ”ì§€ ì²´í¬ (ë®ì–´ì“°ê¸° ìœ„í•´ SHA ì–»ê¸°)
            let finalSha = sha;
            if(!finalSha) {
                try {
                    const check = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/${path}`, {
                        headers: { Authorization: `token ${token}` }
                    });
                    if(check.ok) {
                        const d = await check.json();
                        finalSha = d.sha;
                    }
                } catch(e) {}
            }

            // 2. Blob -> Base64 ë³€í™˜
            const content = await readFileAsBase64(fileBlob);

            // 3. ì—…ë¡œë“œ
            const res = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/${path}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: `Admin V7 update: ${path}`,
                    content: content,
                    sha: finalSha
                })
            });

            if(!res.ok) throw new Error((await res.json()).message);
        }
    </script>
</body>
</html>
